# Remote Worker Deployment
#
# Deploy this on a VPS in a different geographic region to enable
# true multi-location monitoring and performance testing.
#
# Prerequisites:
# 1. Main Supercheck instance running and accessible
# 2. Docker installed on the remote server
# 3. Network connectivity to main instance (Redis, PostgreSQL, MinIO)
#
# Usage:
#   1. Copy this file to your remote VPS
#   2. Create .env with connection details (see .env.example below)
#   3. Run: docker compose -f docker-compose-worker.yml up -d
#
# Environment Variables Required:
#   DATABASE_URL - PostgreSQL connection string to main server
#   REDIS_URL - Redis connection string to main server
#   S3_ENDPOINT - MinIO/S3 endpoint URL (main server or cloud)
#   WORKER_LOCATION - This worker's region: us-east | eu-central | asia-pacific
#   AWS_ACCESS_KEY_ID - S3 credentials
#   AWS_SECRET_ACCESS_KEY - S3 credentials
#
# Example .env file:
# ----------------------------------------
# DATABASE_URL=postgresql://user:pass@main-server.example.com:5432/supercheck
# REDIS_URL=redis://:password@main-server.example.com:6379
# S3_ENDPOINT=http://main-server.example.com:9000
# AWS_ACCESS_KEY_ID=minioadmin
# AWS_SECRET_ACCESS_KEY=minioadmin
# WORKER_LOCATION=us-east
# ----------------------------------------

services:
  worker:
    image: ghcr.io/supercheck-io/supercheck/worker:1.2.1-canary.25
    init: true
    environment:
      # Database connection (required)
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required - PostgreSQL connection to main server}

      # Redis connection (required)
      REDIS_URL: ${REDIS_URL:?REDIS_URL is required - Redis connection to main server}
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Worker location (required)
      # This determines which regional queue this worker processes
      # Options: us-east | eu-central | asia-pacific
      WORKER_LOCATION: ${WORKER_LOCATION:?WORKER_LOCATION is required - set to us-east, eu-central, or asia-pacific}

      # S3/MinIO storage (required)
      S3_ENDPOINT: ${S3_ENDPOINT:?S3_ENDPOINT is required - MinIO/S3 endpoint URL}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?AWS_ACCESS_KEY_ID is required}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?AWS_SECRET_ACCESS_KEY is required}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}

      # Playwright buckets (use same as main server)
      S3_TEST_BUCKET_NAME: ${S3_TEST_BUCKET_NAME:-playwright-test-artifacts}
      S3_JOB_BUCKET_NAME: ${S3_JOB_BUCKET_NAME:-playwright-job-artifacts}
      S3_MONITOR_BUCKET_NAME: ${S3_MONITOR_BUCKET_NAME:-playwright-monitor-artifacts}
      # K6 buckets
      S3_K6_TEST_BUCKET_NAME: ${S3_K6_TEST_BUCKET_NAME:-k6-test-artifacts}
      S3_K6_JOB_BUCKET_NAME: ${S3_K6_JOB_BUCKET_NAME:-k6-job-artifacts}
      # Status page bucket
      S3_STATUS_BUCKET_NAME: ${S3_STATUS_BUCKET_NAME:-status-page-artifacts}
      # Requirements bucket
      S3_REQUIREMENTS_BUCKET_NAME: ${S3_REQUIREMENTS_BUCKET_NAME:-test-requirement-artifacts}

      # Execution configuration
      NODE_ENV: ${NODE_ENV:-production}
      RUNNING_CAPACITY: ${RUNNING_CAPACITY:-1}
      QUEUED_CAPACITY: ${QUEUED_CAPACITY:-10}
      CONTAINER_CPU_LIMIT: ${CONTAINER_CPU_LIMIT:-1.5}
      CONTAINER_MEMORY_LIMIT_MB: ${CONTAINER_MEMORY_LIMIT_MB:-2048}
      TEST_EXECUTION_TIMEOUT_MS: ${TEST_EXECUTION_TIMEOUT_MS:-300000}
      JOB_EXECUTION_TIMEOUT_MS: ${JOB_EXECUTION_TIMEOUT_MS:-3600000}
      K6_TEST_EXECUTION_TIMEOUT_MS: ${K6_TEST_EXECUTION_TIMEOUT_MS:-3600000}
      K6_JOB_EXECUTION_TIMEOUT_MS: ${K6_JOB_EXECUTION_TIMEOUT_MS:-3600000}

      # Playwright configuration
      PLAYWRIGHT_WORKERS: ${PLAYWRIGHT_WORKERS:-1}
      PLAYWRIGHT_RETRIES: ${PLAYWRIGHT_RETRIES:-1}
      PLAYWRIGHT_TRACE: ${PLAYWRIGHT_TRACE:-retain-on-failure}
      PLAYWRIGHT_SCREENSHOT: ${PLAYWRIGHT_SCREENSHOT:-on}
      PLAYWRIGHT_VIDEO: ${PLAYWRIGHT_VIDEO:-retain-on-failure}

    volumes:
      # Docker socket for container-based test execution
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - worker-playwright-reports:/worker/playwright-reports
      - worker-k6-reports:/worker/k6-reports
      - worker-reports:/worker/report

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      replicas: ${WORKER_REPLICAS:-1}
      resources:
        limits:
          cpus: "1.8"
          memory: 3G
        reservations:
          cpus: "0.5"
          memory: 1G

      restart_policy:
        condition: on-failure
        max_attempts: 3
        delay: 15s
        window: 120s

    # Security constraints
    security_opt:
      - no-new-privileges:true

volumes:
  worker-playwright-reports:
    driver: local
  worker-k6-reports:
    driver: local
  worker-reports:
    driver: local
